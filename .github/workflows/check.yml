name: NixOS Configuration Check

on:
    push:
        branches: [main]
    pull_request:
        branches: [main]

jobs:
    check:
        name: Check Flake & Formatting
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v4

            - name: Install Nix
              uses: cachix/install-nix-action@v30
              with:
                  extra_nix_config: |
                      experimental-features = nix-command flakes

            - name: Setup Cachix
              uses: cachix/cachix-action@v15
              with:
                  name: nix-community

            - name: Magic Nix Cache
              uses: DeterminateSystems/magic-nix-cache-action@v8
              with:
                  # Only upload cache from main branch to avoid slow post-build on PRs
                  # PRs still READ from main's cache but don't waste time uploading
                  use-gha-cache: ${{ github.ref == 'refs/heads/main' }}

            - name: Check flake
              run: nix flake check --all-systems

            - name: Check formatting
              run: nix fmt -- --check .

    build-x86:
        name: Build x86_64 Configs
        runs-on: ubuntu-latest
        needs: check
        steps:
            - uses: actions/checkout@v4

            - name: Install Nix
              uses: cachix/install-nix-action@v30
              with:
                  extra_nix_config: |
                      experimental-features = nix-command flakes

            - name: Setup Cachix
              uses: cachix/cachix-action@v15
              with:
                  name: nix-community

            - name: Magic Nix Cache
              uses: DeterminateSystems/magic-nix-cache-action@v8
              with:
                  use-gha-cache: ${{ github.ref == 'refs/heads/main' }}

            - name: Build sancta-choir (x86_64-linux)
              run: nix build .#nixosConfigurations.sancta-choir.config.system.build.toplevel

    build-scripts:
        name: Build Scripts
        runs-on: ubuntu-latest
        needs: check
        strategy:
            matrix:
                script: [install, deploy, bootstrap]
        steps:
            - uses: actions/checkout@v4

            - name: Install Nix
              uses: cachix/install-nix-action@v30
              with:
                  extra_nix_config: |
                      experimental-features = nix-command flakes

            - name: Setup Cachix
              uses: cachix/cachix-action@v15
              with:
                  name: nix-community

            - name: Magic Nix Cache
              uses: DeterminateSystems/magic-nix-cache-action@v8
              with:
                  use-gha-cache: ${{ github.ref == 'refs/heads/main' }}

            - name: Build ${{ matrix.script }} script
              run: nix build .#packages.x86_64-linux.${{ matrix.script }}

    evaluate-aarch64:
        name: Evaluate aarch64 Configs
        runs-on: ubuntu-latest
        needs: check
        steps:
            - uses: actions/checkout@v4

            - name: Install Nix
              uses: cachix/install-nix-action@v30
              with:
                  extra_nix_config: |
                      experimental-features = nix-command flakes
                      extra-platforms = aarch64-linux

            - name: Setup Cachix
              uses: cachix/cachix-action@v15
              with:
                  name: nix-community

            - name: Magic Nix Cache
              uses: DeterminateSystems/magic-nix-cache-action@v8
              with:
                  use-gha-cache: ${{ github.ref == 'refs/heads/main' }}

            - name: Set up QEMU for aarch64 emulation
              uses: docker/setup-qemu-action@v3
              with:
                  platforms: arm64

            - name: Evaluate rpi5 (aarch64-linux)
              run: nix eval .#nixosConfigurations.rpi5.config.system.build.toplevel.drvPath
