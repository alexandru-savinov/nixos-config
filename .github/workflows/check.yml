name: NixOS Configuration Check

on:
    push:
        branches: [main]
    pull_request:
        branches: [main]

jobs:
    check:
        name: Check Flake & Formatting
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v4

            - name: Install Nix
              uses: cachix/install-nix-action@v30
              with:
                  extra_nix_config: |
                      experimental-features = nix-command flakes

            - name: Setup Cachix
              uses: cachix/cachix-action@v15
              with:
                  name: nix-community

            - name: Cache Nix Store
              uses: nix-community/cache-nix-action@v6
              with:
                  # Cache key based on flake.lock - changes when dependencies update
                  primary-key: nix-${{ runner.os }}-check-${{ hashFiles('flake.lock') }}
                  # Restore from partial matches if exact key not found
                  restore-prefixes-all-matches: |
                      nix-${{ runner.os }}-check-
                      nix-${{ runner.os }}-
                  # Only SAVE cache on main branch - PRs read but don't upload
                  # This is the key fix: PRs benefit from cache but skip slow uploads
                  save: ${{ github.ref == 'refs/heads/main' }}
                  # Limit cache size to 5GB to avoid bloat
                  gc-max-store-size: 5G

            - name: Check flake
              run: nix flake check --all-systems

            - name: Check formatting
              run: nix fmt -- --check .

    build-x86:
        name: Build x86_64 Configs
        runs-on: ubuntu-latest
        needs: check
        steps:
            - uses: actions/checkout@v4

            - name: Install Nix
              uses: cachix/install-nix-action@v30
              with:
                  extra_nix_config: |
                      experimental-features = nix-command flakes

            - name: Setup Cachix
              uses: cachix/cachix-action@v15
              with:
                  name: nix-community

            - name: Cache Nix Store
              uses: nix-community/cache-nix-action@v6
              with:
                  primary-key: nix-${{ runner.os }}-build-x86-${{ hashFiles('flake.lock') }}
                  restore-prefixes-all-matches: |
                      nix-${{ runner.os }}-build-x86-
                      nix-${{ runner.os }}-
                  save: ${{ github.ref == 'refs/heads/main' }}
                  gc-max-store-size: 5G

            - name: Build sancta-choir (x86_64-linux)
              run: nix build .#nixosConfigurations.sancta-choir.config.system.build.toplevel

    build-scripts:
        name: Build Scripts
        runs-on: ubuntu-latest
        needs: check
        strategy:
            matrix:
                script: [install, deploy, bootstrap]
        steps:
            - uses: actions/checkout@v4

            - name: Install Nix
              uses: cachix/install-nix-action@v30
              with:
                  extra_nix_config: |
                      experimental-features = nix-command flakes

            - name: Setup Cachix
              uses: cachix/cachix-action@v15
              with:
                  name: nix-community

            - name: Cache Nix Store
              uses: nix-community/cache-nix-action@v6
              with:
                  primary-key: nix-${{ runner.os }}-scripts-${{ matrix.script }}-${{ hashFiles('flake.lock') }}
                  restore-prefixes-all-matches: |
                      nix-${{ runner.os }}-scripts-${{ matrix.script }}-
                      nix-${{ runner.os }}-scripts-
                      nix-${{ runner.os }}-
                  save: ${{ github.ref == 'refs/heads/main' }}
                  gc-max-store-size: 5G

            - name: Build ${{ matrix.script }} script
              run: nix build .#packages.x86_64-linux.${{ matrix.script }}

    evaluate-aarch64:
        name: Evaluate aarch64 Configs
        runs-on: ubuntu-latest
        needs: check
        steps:
            - uses: actions/checkout@v4

            - name: Install Nix
              uses: cachix/install-nix-action@v30
              with:
                  extra_nix_config: |
                      experimental-features = nix-command flakes
                      extra-platforms = aarch64-linux

            - name: Setup Cachix
              uses: cachix/cachix-action@v15
              with:
                  name: nix-community

            - name: Cache Nix Store
              uses: nix-community/cache-nix-action@v6
              with:
                  primary-key: nix-${{ runner.os }}-aarch64-${{ hashFiles('flake.lock') }}
                  restore-prefixes-all-matches: |
                      nix-${{ runner.os }}-aarch64-
                      nix-${{ runner.os }}-
                  save: ${{ github.ref == 'refs/heads/main' }}
                  gc-max-store-size: 5G

            - name: Set up QEMU for aarch64 emulation
              uses: docker/setup-qemu-action@v3
              with:
                  platforms: arm64

            - name: Evaluate rpi5 (aarch64-linux)
              run: nix eval .#nixosConfigurations.rpi5.config.system.build.toplevel.drvPath
