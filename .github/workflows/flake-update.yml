name: Flake Update

on:
  schedule:
    # Nightly at 02:00 UTC â€” nixpkgs only (security patches)
    - cron: "0 2 * * *"
    # Weekly on Monday at 09:00 UTC
    - cron: "0 9 * * 1"
  workflow_dispatch:
    inputs:
      update_all:
        description: "Update all inputs (true) or only nixpkgs (false)"
        required: false
        default: "true"
        type: boolean

permissions:
  contents: write
  pull-requests: write

jobs:
  update-flake:
    name: Update Flake Inputs
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install Nix
        uses: cachix/install-nix-action@v30
        with:
          extra_nix_config: |
            experimental-features = nix-command flakes

      - name: Setup Cachix
        uses: cachix/cachix-action@v15
        with:
          name: nix-community

      - name: Get current flake.lock hash
        id: before
        run: echo "hash=$(sha256sum flake.lock | cut -d' ' -f1)" >> $GITHUB_OUTPUT

      - name: Determine update scope
        id: scope
        env:
          EVENT_SCHEDULE: ${{ github.event.schedule }}
          UPDATE_ALL: ${{ inputs.update_all }}
        run: |
          if [ "$EVENT_SCHEDULE" = "0 2 * * *" ]; then
            echo "nightly=true" >> $GITHUB_OUTPUT
            echo "mode=nightly" >> $GITHUB_OUTPUT
          else
            echo "nightly=false" >> $GITHUB_OUTPUT
            if [ "$UPDATE_ALL" = "false" ]; then
              echo "mode=nixpkgs-only" >> $GITHUB_OUTPUT
            else
              echo "mode=full" >> $GITHUB_OUTPUT
            fi
          fi

      - name: Update flake inputs
        env:
          MODE: ${{ steps.scope.outputs.mode }}
        run: |
          if [ "$MODE" = "nightly" ] || [ "$MODE" = "nixpkgs-only" ]; then
            echo "Updating nixpkgs inputs only..."
            nix flake update nixpkgs nixpkgs-unstable
          else
            echo "Updating all flake inputs..."
            nix flake update
          fi

      - name: Get updated flake.lock hash
        id: after
        run: echo "hash=$(sha256sum flake.lock | cut -d' ' -f1)" >> $GITHUB_OUTPUT

      - name: Check for changes
        id: changes
        run: |
          if [ "${{ steps.before.outputs.hash }}" != "${{ steps.after.outputs.hash }}" ]; then
            echo "changed=true" >> $GITHUB_OUTPUT
          else
            echo "changed=false" >> $GITHUB_OUTPUT
          fi

      - name: Verify flake still builds
        if: steps.changes.outputs.changed == 'true'
        run: |
          echo "Checking flake validity..."
          nix flake check --all-systems

          echo "Evaluating sancta-choir configuration..."
          nix eval .#nixosConfigurations.sancta-choir.config.system.build.toplevel.drvPath

      # Nightly: commit directly to main (security patches, already validated above)
      - name: Push directly to main
        if: steps.changes.outputs.changed == 'true' && steps.scope.outputs.nightly == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add flake.lock
          git commit -m "chore(deps): nightly nixpkgs security update"
          git push origin main

      # Weekly/manual: create a PR for manual review
      - name: Generate update summary
        if: steps.changes.outputs.changed == 'true' && steps.scope.outputs.nightly == 'false'
        id: summary
        run: |
          {
            echo 'summary<<EOF'
            echo "## Flake Input Updates"
            echo ""
            echo "### Changed Inputs"
            echo '```diff'
            git diff flake.lock | head -60
            echo '```'
            echo ""
            echo "### Verification Checklist"
            echo ""
            echo "- [ ] CI builds pass"
            echo "- [ ] No breaking changes in upstream changelogs"
            echo "- [ ] Test deployment if concerned"
            echo EOF
          } >> $GITHUB_OUTPUT

      - name: Create Pull Request
        if: steps.changes.outputs.changed == 'true' && steps.scope.outputs.nightly == 'false'
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "chore(deps): update flake inputs"
          title: "chore(deps): Update Nix flake inputs"
          body: |
            ${{ steps.summary.outputs.summary }}

            ---
            *Automatically created by flake-update workflow*
          branch: chore/update-flake-lock
          delete-branch: true
          labels: |
            dependencies
            automated
