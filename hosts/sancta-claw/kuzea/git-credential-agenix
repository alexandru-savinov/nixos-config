# Git credential helper: reads GitHub PAT from the agenix-managed secret.
# Replaces plaintext ~/.git-credentials so the token is never stored in clear text.
# Shebang is injected by pkgs.writeShellScript (points to nix store bash).
#
# Only 'get' is supported; 'store' and 'erase' are intentional no-ops because
# the token is managed by agenix and must never be written to or removed from
# disk by git.
if [ "$1" = "get" ]; then
  # Parse key=value pairs from stdin to determine the requesting context.
  while IFS='=' read -r key val; do
    case "$key" in
      protocol) protocol="$val" ;;
      host)     host="$val" ;;
    esac
  done
  # Only serve credentials for GitHub over HTTPS; silently decline all others.
  [ "$protocol" = "https" ] && [ "$host" = "github.com" ] || exit 0
  TOKEN=$(cat /run/agenix/kuzea-github-token 2>/dev/null | tr -d '[:space:]')
  [ -z "$TOKEN" ] && exit 1
  printf 'username=alexandru-savinov\n'
  printf 'password=%s\n' "$TOKEN"
fi
