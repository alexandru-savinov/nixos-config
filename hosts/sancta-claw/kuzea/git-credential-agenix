# Git credential helper: reads GitHub PAT from the agenix-managed secret.
# Replaces plaintext ~/.git-credentials so the token is never stored in clear text.
# Shebang is injected by pkgs.writeShellScript (points to nix store bash).
#
# Only 'get' is supported; 'store' and 'erase' are intentional no-ops because
# the token is managed by agenix and must never be written to or removed from
# disk by git.
if [ "$1" = "get" ]; then
  # Parse key=value pairs from stdin to determine the requesting context.
  # Use suffix/prefix stripping (not IFS='=') to safely handle values that
  # contain '=' characters (e.g. base64-encoded tokens).
  while IFS= read -r line; do
    key="${line%%=*}"
    val="${line#*=}"
    case "$key" in
      protocol) protocol="$val" ;;
      host)     host="$val" ;;
    esac
  done
  # Only serve credentials for GitHub over HTTPS; silently decline all others.
  # Explicit if/then makes the intent clear despite && / || precedence rules.
  if ! { [ "$protocol" = "https" ] && [ "$host" = "github.com" ]; }; then
    exit 0
  fi
  TOKEN=$(cat /run/agenix/kuzea-github-token 2>/dev/null | tr -d '[:space:]')
  [ -z "$TOKEN" ] && exit 1
  # Username is hardcoded for this single-user setup; the agenix secret holds
  # only the PAT. Change here if the secret format ever moves to user:token.
  printf 'username=alexandru-savinov\n'
  printf 'password=%s\n' "$TOKEN"
fi
